<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fashion Search AI</title>
  <style>
    :root {
      --fg: #222;
      --muted: #666;
      --line: #ddd;
      --bg: #fafafa;
    }
    body {
      font-family: Arial, sans-serif;
      color: var(--fg);
      margin: 0;
      padding: 32px 24px;
      background: #fff;
    }
    h1 {
      font-size: 32px;
      margin: 0 0 18px;
    }
    .toolbar {
      display: flex;
      gap: 12px;
      margin-bottom: 18px;
    }
    input {
      flex: 1;
      padding: 12px 14px;
      font-size: 16px;
      border: 1px solid var(--line);
      border-radius: 8px;
    }
    button {
      padding: 12px 18px;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: #fff;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .summary {
      margin-bottom: 12px;
      font-size: 14px;
      color: var(--muted);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    .card {
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      background: var(--bg);
    }
    .imgwrap {
      width: 100%;
      aspect-ratio: 3 / 2;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .imgwrap img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }
    .content {
      padding: 12px 14px 14px;
    }
    .title {
      font-weight: 700;
      font-size: 15px;
      line-height: 1.3;
      margin: 0 0 6px;
    }
    .sub {
      font-size: 13px;
      color: var(--muted);
    }
    .reason {
      margin-top: 8px;
      font-size: 13px;
      color: #205c2a;
    }

    .loading {
      display: none;
      align-items: center;
      gap: 10px;
      margin: 10px 0 16px;
      font-size: 13px;
      color: var(--muted);
    }
    .loading.show {
      display: flex;
    }
    .spinner {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid #bbb;
      border-top-color: #333;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Skeleton cards */
    .skel {
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      background: #f3f3f3;
    }
    .skel .imgwrap {
      background: #e3e3e3;
    }
    .skel .content > div {
      height: 12px;
      background: #dedede;
      margin: 6px 0;
      border-radius: 6px;
    }
    .skel .content > div:first-child {
      height: 16px;
      width: 75%;
    }
    .skel .content > div:nth-child(2) {
      width: 55%;
    }
    .skel .content > div:nth-child(3) {
      width: 65%;
    }

    .section {
      margin-top: 26px;
    }
    .panel {
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
    }
    .panel-header {
      padding: 8px 12px;
      border-bottom: 1px solid var(--line);
      background: #fafafa;
      font-size: 14px;
      font-weight: 600;
    }
    .panel-body {
      padding: 8px 12px;
    }
    pre {
      margin: 0;
      white-space: pre-wrap;
      font-size: 12px;
      max-height: 350px;
      overflow: auto;
    }

    @media (max-width: 600px) {
      h1 { font-size: 26px; }
    }
  </style>
</head>
<body>

<h1>Fashion Search AI</h1>

<div class="toolbar">
  <input id="q" placeholder="e.g. red women dress, blue denim men shirt, black running shoes" />
  <button id="searchBtn" onclick="searchNow()">Search</button>
</div>

<div id="loading" class="loading">
  <div class="spinner"></div>
  <div>Finding the best recommendations...</div>
</div>

<div id="summary" class="summary"></div>

<div id="cards" class="grid"></div>

<div class="section">
  <div class="panel">
    <div class="panel-header">Raw recommendation JSON (for debugging / report)</div>
    <div class="panel-body">
      <pre id="json-out"></pre>
    </div>
  </div>
</div>

<script>
function placeholder(img) {
  img.src = "";
  img.parentElement.style.background = "#ddd";
  img.alt = "Image unavailable";
}

function renderSkeletons(n = 3) {
  const cards = document.getElementById("cards");
  cards.innerHTML = "";
  for (let i = 0; i < n; i++) {
    const el = document.createElement("div");
    el.className = "card skel";
    el.innerHTML = `
      <div class="imgwrap"></div>
      <div class="content">
        <div></div>
        <div></div>
        <div></div>
      </div>`;
    cards.appendChild(el);
  }
}

async function searchNow() {
  const qInput = document.getElementById("q");
  const btn = document.getElementById("searchBtn");
  const loading = document.getElementById("loading");
  const cards = document.getElementById("cards");
  const jsonOut = document.getElementById("json-out");
  const summary = document.getElementById("summary");

  const q = qInput.value.trim();
  if (!q) return;

  // start loading state
  btn.disabled = true;
  qInput.disabled = true;
  loading.classList.add("show");
  summary.textContent = "";
  jsonOut.textContent = "";
  renderSkeletons(3);

  try {
    const res = await fetch("/recommend", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query: q, k: 3 })
    });

    if (!res.ok) {
      throw new Error("Server returned " + res.status);
    }

    const apiPayload = await res.json();

    // apiPayload.generated is a JSON string
    let gen;
    try {
      gen = JSON.parse(apiPayload.generated);
    } catch (e) {
      // if parsing fails, show raw
      jsonOut.textContent = JSON.stringify(apiPayload, null, 2);
      cards.innerHTML = "<div style='color:#a00;'>Failed to parse generated JSON.</div>";
      return;
    }

    jsonOut.textContent = JSON.stringify(gen, null, 2);

    const recs = gen.recommendations || [];
    summary.textContent = gen.final_answer || "";

    cards.innerHTML = "";
    if (recs.length === 0) {
      cards.innerHTML = "<div style='color:#666;'>No recommendations for this query. Try rephrasing.</div>";
      return;
    }

    recs.forEach(p => {
      const el = document.createElement("div");
      el.className = "card";
      const imgSrc = p.image || "";
      const price = (p.price !== undefined && p.price !== null) ? p.price : "NA";
      el.innerHTML = `
        <div class="imgwrap">
          <img loading="lazy" src="${imgSrc}" onerror="placeholder(this)" alt="">
        </div>
        <div class="content">
          <div class="title">${p.name || "Unnamed product"}</div>
          <div class="sub">
            ${p.brand || "Brand NA"} — ${p.colour || "Colour NA"} — ₹${price}
          </div>
          ${p.reason ? `<div class="reason">Why: ${p.reason}</div>` : ""}
        </div>
      `;
      cards.appendChild(el);
    });

  } catch (err) {
    cards.innerHTML = "<div style='color:#a00;'>Request failed. Please check the backend and try again.</div>";
    jsonOut.textContent = String(err);
  } finally {
    loading.classList.remove("show");
    btn.disabled = false;
    qInput.disabled = false;
  }
}
</script>

</body>
</html>
